@defer (when isLoaded()) {
  <div class="container with-table pt-3 mb-2" data-testid="expenses-container">
    <div class="page-header" data-testid="expenses-page-header">
      <div></div>
      <h3 data-testid="expenses-page-title">Expenses</h3>
      <div class="help-icon" data-testid="expenses-help-icon-container">
        @if (demoService.isInDemoMode()) {
          <mat-icon
            data-testid="expenses-tour-button"
            matTooltip="Show Tour"
            (click)="startTour()"
            aria-label="Start expenses tour"
            class="mr-2"
            >tour</mat-icon
          >
        }
        <mat-icon
          matTooltip="Help"
          (click)="showHelp()"
          data-testid="expenses-help-button"
          aria-label="Show help for expenses"
          >help</mat-icon
        >
      </div>
    </div>
    <h4 data-testid="current-group-name">{{ currentGroup()?.name }}</h4>
    <div class="filters" data-testid="expense-filters">
      <mat-form-field class="datepicker" subscriptSizing="dynamic">
        <mat-label>Start date</mat-label>
        <input
          matInput
          [matDatepicker]="startDatepicker"
          [(ngModel)]="startDate"
          appDateShortcutKeys
        />
        @if (!startDate()) {
          <mat-datepicker-toggle
            matIconSuffix
            [for]="startDatepicker"
          ></mat-datepicker-toggle>
        } @else {
          <button
            matSuffix
            matIconButton
            tabindex="-1"
            aria-label="Clear"
            (click)="startDate.set(null)"
            [matTooltip]="'Clear'"
          >
            <mat-icon>close</mat-icon>
          </button>
        }
        <mat-datepicker #startDatepicker></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="datepicker" subscriptSizing="dynamic">
        <mat-label>End date</mat-label>
        <input
          matInput
          [matDatepicker]="endDatePicker"
          [(ngModel)]="endDate"
          appDateShortcutKeys
        />
        @if (!endDate()) {
          <mat-datepicker-toggle
            matIconSuffix
            [for]="endDatePicker"
          ></mat-datepicker-toggle>
        }
        @if (!!endDate()) {
          <button
            matSuffix
            matIconButton
            tabindex="-1"
            aria-label="Clear"
            (click)="endDate.set(null)"
            [matTooltip]="'Clear'"
          >
            <mat-icon>close</mat-icon>
          </button>
        }
        <mat-datepicker #endDatePicker></mat-datepicker>
      </mat-form-field>
      <mat-slide-toggle
        #unpaidToggle
        class="unpaid-toggle"
        [checked]="true"
        [(ngModel)]="unpaidOnly"
        >Unpaid only</mat-slide-toggle
      >
    </div>
    <div class="filters placeholder-selects">
      <mat-form-field subscriptSizing="dynamic" class="payer-select">
        @if (!!searchPayer()) {
          <mat-label>Payer</mat-label>
        }
        <mat-select
          [(ngModel)]="searchPayer"
          docRefCompare
          placeholder="-- All Payers --"
        >
          <mat-option [value]="null">-- All Payers --</mat-option>
          @for (member of members(); track member.ref) {
            <mat-option [value]="member.ref">
              {{ member.displayName }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
      @if (categories().length > 1) {
        <mat-form-field subscriptSizing="dynamic" class="category-select">
          @if (!!searchCategory()) {
            <mat-label>Category</mat-label>
          }
          <mat-select
            [(ngModel)]="searchCategory"
            docRefCompare
            placeholder="-- All Categories --"
          >
            <mat-option [value]="null">-- All Categories --</mat-option>
            @for (category of categories(); track category.ref) {
              <mat-option [value]="category.ref">
                {{ category.name }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      }
    </div>
    <div class="filters mt-3">
      <button
        matButton="elevated"
        type="button"
        class="btn-primary fetch-button"
        (click)="loadExpenses()"
      >
        Fetch Expenses
      </button>
      <button
        matButton="elevated"
        class="btn-primary add-button"
        (click)="onAddExpenseClick()"
        data-tour="add-expense-button"
      >
        Add New Expense
      </button>
    </div>
    @if (expenses()?.length >= 200) {
      <div class="alert alert-warning mt-3" role="alert">
        <strong>Note:</strong> You have reached the maximum number of expenses
        (200) that can be fetched at once.<br />
        Please refine your search criteria and fetch again to see more specific
        results.
      </div>
    }
    @if (expenses()?.length > 0) {
      <div class="table-container mat-elevation-z8" data-tour="expenses-list">
        <div class="scrollable-table">
          <table
            mat-table
            matSort
            [dataSource]="filteredExpenses()"
            (matSortChange)="sortExpenses($event)"
            multiTemplateDataRows
            class="expandable-table"
          >
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>Id</th>
              <td mat-cell *matCellDef="let expense">{{ expense.id }}</td>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-container>
            <ng-container matColumnDef="date-paidBy">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                class="cell-left no-wrap"
                appSelectFilter
                [filterKey]="'paidByMemberRef'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Payer'"
                [filterOptions]="members()"
                [filterLabel]="'Select payer'"
                [displayFn]="memberDisplayFn"
              >
                Date<br />Payer
              </th>
              <td mat-cell *matCellDef="let expense" class="no-wrap">
                {{ expense.date | date: 'M/d/yy' }}
                <br />
                {{ expense.paidByMember.displayName }}
              </td>
            </ng-container>
            <ng-container matColumnDef="date">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                class="cell-left"
                appDateRangeFilter
                [filterKey]="'date'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Date'"
              >
                Date
              </th>
              <td mat-cell *matCellDef="let expense" class="no-wrap">
                {{ expense.date | date: 'M/d/yyyy' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="paidBy">
              <th
                mat-header-cell
                *matHeaderCellDef
                appSelectFilter
                [filterKey]="'paidByMemberRef'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Payer'"
                [filterOptions]="members()"
                [filterLabel]="'Select payer'"
                [displayFn]="memberDisplayFn"
              >
                Payer
              </th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.paidByMember.displayName }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description-category">
              <th
                mat-header-cell
                *matHeaderCellDef
                appSelectFilter
                [filterKey]="'categoryRef'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Category'"
                [filterOptions]="categories()"
                [filterLabel]="'Select category'"
                [displayFn]="categoryDisplayFn"
              >
                Description<br />Category
              </th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.description }}
                <br />
                {{ expense.category.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th
                mat-header-cell
                *matHeaderCellDef
                appTextFilter
                [filterKey]="'description'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Description'"
              >
                Description
              </th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.description }}
              </td>
            </ng-container>
            <ng-container matColumnDef="category">
              <th
                mat-header-cell
                *matHeaderCellDef
                appSelectFilter
                [filterKey]="'categoryRef'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Category'"
                [filterOptions]="categories()"
                [filterLabel]="'Select category'"
                [displayFn]="categoryDisplayFn"
              >
                Category
              </th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.category.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef class="cell-right">
                Amount
              </th>
              <td
                mat-cell
                *matCellDef="let expense"
                class="cell-right amount-cell"
              >
                {{ expense.totalAmount | currency }}
              </td>
              <td
                mat-footer-cell
                *matFooterCellDef
                class="cell-right"
                [colSpan]="this.smallScreen() ? 3 : 5"
              >
                Total:&nbsp;&nbsp;{{ expenseTotal() | currency }}
              </td>
            </ng-container>
            <ng-container matColumnDef="receipt">
              <th mat-header-cell *matHeaderCellDef class="cell-center">
                Rcpt
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                {{ expense.hasReceipt | yesNo }}
              </td>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-container>
            <ng-container matColumnDef="paid">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="cell-center"
                appToggleFilter
                [filterKey]="'paid'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Paid'"
              >
                Paid
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                {{ expense.paid | yesNo }}
              </td>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-container>
            <ng-container matColumnDef="receipt-paid">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="cell-center no-wrap"
                appToggleFilter
                [filterKey]="'paid'"
                [filterService]="expenseFilterService"
                [columnHeader]="'Paid'"
              >
                Rcpt<br />Paid
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                {{ expense.hasReceipt | yesNo }}
                <br />
                {{ expense.paid | yesNo }}
              </td>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-container>
            <ng-container matColumnDef="expand">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="cell-center"
                aria-label="row actions"
              >
                <mat-icon fontSet="material-symbols-outlined"
                  >arrow_split</mat-icon
                >
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                <button
                  mat-icon-button
                  aria-label="expand row"
                  (click)="onExpandClick(expense); $event.stopPropagation()"
                >
                  @if (expandedExpense() === expense) {
                    <mat-icon>keyboard_arrow_up</mat-icon>
                  } @else {
                    <mat-icon>keyboard_arrow_down</mat-icon>
                  }
                </button>
              </td>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let expense"
                [colSpan]="columnsToDisplay().length"
              >
                @if (expense == expandedExpense()) {
                  <div
                    class="detail-table-container"
                    animate.enter="detail-expand"
                    animate.leave="detail-collapse"
                  >
                    <table
                      mat-table
                      [dataSource]="expense.splits"
                      class="static-table"
                      (click)="
                        copyExpenseSummaryToClipboard(expense);
                        $event.stopPropagation()
                      "
                      matTooltip="Click to copy expense summary"
                      [matTooltipDisabled]="false"
                      #tableTooltip="matTooltip"
                    >
                      @let splitColumnsToDisplay =
                        ['owedBy', 'amount', 'paid', 'mark'];
                      <ng-container matColumnDef="id">
                        <th mat-header-cell *matHeaderCellDef>Id</th>
                        <td mat-cell *matCellDef="let split">{{ split.id }}</td>
                      </ng-container>
                      <ng-container matColumnDef="owedBy">
                        <th mat-header-cell *matHeaderCellDef>Owed By</th>
                        <td mat-cell *matCellDef="let split">
                          {{ split.owedByMember.displayName }}
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="amount">
                        <th
                          mat-header-cell
                          *matHeaderCellDef
                          class="cell-right"
                        >
                          Amount
                        </th>
                        <td mat-cell *matCellDef="let split" class="cell-right">
                          {{ split.allocatedAmount | currency }}
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="paid">
                        <th
                          mat-header-cell
                          *matHeaderCellDef
                          class="cell-center"
                        >
                          Paid
                        </th>
                        <td
                          mat-cell
                          *matCellDef="let split"
                          class="cell-center"
                        >
                          {{
                            split.paid
                              | yesNoNa
                                : split.paidByMemberRef
                                : split.owedByMemberRef
                          }}
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="mark">
                        <th
                          mat-header-cell
                          *matHeaderCellDef
                          class="cell-center"
                          style="width: 60px"
                        >
                          Mark Paid/Unpaid
                        </th>
                        <td
                          mat-cell
                          *matCellDef="let split"
                          class="cell-center"
                        >
                          @if (
                            expense.paidByMemberRef.path !=
                            split.owedByMemberRef.path
                          ) {
                            <button
                              mat-mini-fab
                              class="btn"
                              [class]="
                                split.paid ? 'btn-danger' : 'btn-success'
                              "
                              (click)="
                                markSplitPaidUnpaid(expense, split);
                                $event.stopPropagation()
                              "
                              (mouseenter)="tableTooltip.disabled = true"
                              (mouseleave)="
                                tableTooltip.disabled = false;
                                tableTooltip.show()
                              "
                              [title]="
                                split.paid
                                  ? 'Mark split unpaid'
                                  : 'Mark split paid'
                              "
                            >
                              <mat-icon>paid</mat-icon>
                            </button>
                          }
                        </td>
                      </ng-container>
                      <tr
                        mat-header-row
                        *matHeaderRowDef="splitColumnsToDisplay"
                      ></tr>
                      <tr
                        mat-row
                        *matRowDef="let split; columns: splitColumnsToDisplay"
                      ></tr>
                    </table>
                  </div>
                }
              </td>
            </ng-container>
            <tr
              mat-header-row
              *matHeaderRowDef="columnsToDisplay(); sticky: true"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let expense;
                columns: columnsToDisplay();
                let isFirst = first
              "
              class="summary-row clickable-row expandable-row"
              [class.expanded-row]="expandedExpense() === expense"
              [attr.data-tour]="isFirst ? 'expense-row' : null"
              (click)="onRowClick(expense)"
            ></tr>
            <tr
              mat-footer-row
              *matFooterRowDef="footerColumnsToDisplay(); sticky: true"
            ></tr>
            <tr *matNoDataRow class="no-data-row">
              <td
                class="mat-mdc-cell mdc-data-table__cell cdk-cell no-data-cell"
                [attr.colspan]="columnsToDisplay().length"
              >
                No expenses match the filter criteria.
              </td>
            </tr>
            <tr
              mat-row
              *matRowDef="let split; columns: ['expandedDetail']"
              class="detail-row"
            ></tr>
          </table>
        </div>
      </div>
    } @else {
      <div class="container pt-3">
        <h5>No expenses found</h5>
      </div>
    }
  </div>
} @placeholder {
  <div class="placeholder-content">
    <mat-icon class="placeholder-icon">hourglass_empty</mat-icon>
    <h3 class="placeholder-text">Loading expenses...</h3>
  </div>
}
