<div class="container pt-3" data-test-id="add-expense-container">
  <div class="page-header" data-test-id="page-header">
    <div></div>
    <h3 data-test-id="page-title">Add Expense</h3>
    <div class="help-icon" data-test-id="help-icon-container">
      @if (demoService.isInDemoMode()) {
        <mat-icon
          data-testid="add-expense-tour-button"
          matTooltip="Show Tour"
          (click)="startTour()"
          aria-label="Start add expense tour"
          class="mr-2"
          >tour</mat-icon
        >
      }
      <mat-icon
        matTooltip="Help"
        (click)="showHelp()"
        data-test-id="help-button"
        aria-label="Show help for adding expenses"
        >help</mat-icon
      >
    </div>
  </div>
  @let members = activeMembers();
  <div class="mb-2">
    <form
      [formGroup]="addExpenseForm"
      id="expense-form"
      data-test-id="add-expense-form"
      aria-label="Add expense form"
    >
      <div class="flex-wrap fw-start" data-tour="basic-info">
        <mat-form-field id="paid-by-select" data-test-id="payer-field">
          <mat-label>Payer</mat-label>
          <mat-select
            formControlName="paidByMember"
            name="paidByMember"
            docRefCompare
            data-test-id="payer-select"
            aria-label="Select who paid for this expense"
          >
            @for (member of members; track member.ref) {
              <mat-option [value]="member.ref">{{
                member.displayName
              }}</mat-option>
            }
          </mat-select>
          @if (e.paidByMember.errors?.['required']) {
            <mat-error data-test-id="payer-error"> *Required </mat-error>
          }
        </mat-form-field>
        <mat-form-field
          appearance="fill"
          class="datepicker-with-hint"
          subscriptSizing="dynamic"
          data-test-id="date-field"
        >
          <mat-label>Date</mat-label>
          <input
            matInput
            formControlName="date"
            [matDatepicker]="expenseDatePicker"
            appDateShortcutKeys
            #datePicker
            data-test-id="date-input"
            aria-label="Select expense date"
          />
          <mat-hint>+/- to change date</mat-hint>
          <mat-datepicker-toggle
            matIconSuffix
            [for]="expenseDatePicker"
            data-test-id="date-picker-toggle"
            aria-label="Open date picker"
          ></mat-datepicker-toggle>
          <mat-datepicker
            #expenseDatePicker
            data-test-id="date-picker"
          ></mat-datepicker>
          @if (e.date.errors?.['required']) {
            <mat-error data-test-id="date-error"> *Required </mat-error>
          }
        </mat-form-field>
      </div>
      <div class="flex-wrap fw-start">
        <mat-form-field
          appearance="fill"
          id="description"
          data-test-id="description-field"
        >
          <mat-label>Description</mat-label>
          <input
            matInput
            formControlName="description"
            data-test-id="description-input"
            aria-label="Enter expense description"
          />
          @if (e.description.errors?.['required']) {
            <mat-error> *Required </mat-error>
          }
        </mat-form-field>
        <mat-form-field
          id="category-select"
          [class.hidden]="activeCategories().length === 1"
        >
          <mat-label>Category</mat-label>
          <mat-select formControlName="category" name="category" docRefCompare>
            @for (category of activeCategories(); track category.ref) {
              <mat-option [value]="category.ref">{{
                category.name
              }}</mat-option>
            }
          </mat-select>
          @if (e.category.errors?.['required']) {
            <mat-error> *Required </mat-error>
          }
        </mat-form-field>
      </div>
      <div class="flex-wrap fw-start" data-tour="amount-fields">
        <mat-form-field
          appearance="fill"
          floatLabel="always"
          class="total-amount-field"
        >
          <mat-label>Total Amount</mat-label>
          <input
            matInput
            #inputElement
            #totalAmount
            formControlName="amount"
            class="number-right"
            appFormatCurrencyInput
            (blur)="updateTotalAmount()"
            inputmode="decimal"
          />
          @if (localeService.currency().symbolPosition === 'prefix') {
            <span matTextPrefix>{{ localeService.currency().symbol }}</span>
          }
          @if (localeService.currency().symbolPosition === 'suffix') {
            <span matTextSuffix
              >&nbsp;{{ localeService.currency().symbol }}</span
            >
          }
          <button
            matIconSuffix
            mat-icon-button
            (click)="
              openCalculator($event, 'amount');
              $event.preventDefault();
              $event.stopPropagation()
            "
            aria-label="Open calculator"
            type="button"
          >
            <mat-icon>calculate</mat-icon>
          </button>
          @if (e.amount.errors?.['required']) {
            <mat-error> *Required </mat-error>
          }
          @if (e.amount.errors?.['zeroAmount']) {
            <mat-error> Cannot be zero </mat-error>
          }
        </mat-form-field>
        <mat-form-field
          appearance="fill"
          floatLabel="always"
          class="proportional-amount-field"
          [class.hidden]="splitByPercentage()"
        >
          <mat-label>Proportional Amount</mat-label>
          <input
            matInput
            #inputElement
            #propAmount
            formControlName="allocatedAmount"
            class="number-right"
            appFormatCurrencyInput
            (blur)="allocateSharedAmounts()"
            inputmode="decimal"
          />
          @if (localeService.currency().symbolPosition === 'prefix') {
            <span matTextPrefix>{{ localeService.currency().symbol }}</span>
          }
          @if (localeService.currency().symbolPosition === 'suffix') {
            <span matTextSuffix
              >&nbsp;{{ localeService.currency().symbol }}</span
            >
          }
          <button
            matIconSuffix
            mat-icon-button
            (click)="
              openCalculator($event, 'allocatedAmount');
              $event.preventDefault();
              $event.stopPropagation()
            "
            aria-label="Open calculator"
            type="button"
          >
            <mat-icon>calculate</mat-icon>
          </button>
          <mat-hint>Tax, tip, etc.</mat-hint>
          @if (e.allocatedAmount.errors?.['required']) {
            <mat-error> *Required - Enter 0 if none </mat-error>
          }
        </mat-form-field>
        <div class="mock-input" [class.hidden]="splitByPercentage()">
          <span class="mock-label">Evenly Shared Remainder</span>
          <span class="mock-value-right">
            {{ e.sharedAmount.value | currency }}
          </span>
        </div>
      </div>
      <div class="mb-3">
        @if (!!fileName()) {
          <div
            (click)="removeFile()"
            class="attachment"
            data-test-id="remove-file-attachment"
          >
            <button
              mat-mini-fab
              class="btn btn-danger"
              data-test-id="remove-file-button"
              aria-label="Remove attached receipt file"
            >
              <mat-icon>delete</mat-icon>
            </button>
            <span class="filename" data-test-id="attached-filename">{{
              fileName()
            }}</span>
          </div>
        } @else {
          <div
            (click)="openFileSelectionDialog()"
            class="attachment"
            data-test-id="attach-file-area"
          >
            <input
              type="file"
              accept=".pdf,image/*"
              class="file-input"
              #attachFile
              (change)="onFileSelected($event)"
              data-test-id="file-input"
              aria-label="Select receipt file to upload"
            />
            <button
              mat-mini-fab
              class="btn btn-success"
              data-test-id="attach-file-button"
              aria-label="Attach receipt file"
            >
              <mat-icon>attach_file</mat-icon>
            </button>
            <span class="filename" data-test-id="upload-prompt"
              >Upload receipt</span
            >
          </div>
        }
      </div>
      <div class="flex-wrap fw-start row-gap" data-tour="split-controls">
        <button
          mat-raised-button
          class="btn-primary"
          type="button"
          (click)="addSplit()"
          data-test-id="add-split-button"
          aria-label="Add expense split for member"
        >
          Add New Split
        </button>
        <button
          mat-raised-button
          class="btn-primary"
          type="button"
          (click)="addAllActiveGroupMembers()"
          data-test-id="add-all-members-button"
          aria-label="Add splits for all members"
        >
          Add All Members
        </button>
        <div class="split-button-container">
          <button
            mat-raised-button
            class="left-half-btn"
            [class.btn-primary]="!splitByPercentage()"
            [class.btn-unselected]="splitByPercentage()"
            type="button"
            (click)="onSplitByAmountClick()"
            data-test-id="split-by-amount-button"
            aria-label="Change to split by amount"
            matTooltip="Split by Amount"
          >
            <mat-icon>attach_money</mat-icon>
          </button>
          <button
            mat-raised-button
            class="right-half-btn"
            [class.btn-primary]="splitByPercentage()"
            [class.btn-unselected]="!splitByPercentage()"
            type="button"
            (click)="onSplitByPercentageClick()"
            data-test-id="split-by-percentage-button"
            aria-label="Change to split by percentage"
            matTooltip="Split by Percentage"
          >
            <mat-icon>percent</mat-icon>
          </button>
        </div>
      </div>
      <div formArrayName="splits" class="mt-3">
        @for (
          splitForm of splitsFormArray.controls;
          track splitForm;
          let i = $index
        ) {
          <div [formGroupName]="i" class="flex-wrap fw-start row-gap">
            <div class="splits-1">
              <mat-form-field id="split-member" subscriptSizing="dynamic">
                <mat-label>Member</mat-label>
                <mat-select
                  formControlName="owedByMemberRef"
                  (selectionChange)="allocateSharedAmounts()"
                  docRefCompare
                >
                  @for (member of members; track member.ref) {
                    <mat-option [value]="member.ref">{{
                      member.displayName
                    }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <button mat-mini-fab class="btn-danger" (click)="removeSplit(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <div class="flex-wrap fw-start row-gap">
              @if (splitByPercentage()) {
                <mat-form-field
                  appearance="fill"
                  class="number-field no-subscript"
                  [class.locked-input]="isLastSplit(i)"
                  subscriptSizing="dynamic"
                  [matTooltip]="
                    isLastSplit(i)
                      ? 'The last split percentage is automatically calculated to make the total 100%'
                      : ''
                  "
                >
                  <mat-label>Percentage</mat-label>
                  <input
                    matInput
                    #inputElement
                    #memberPercentage
                    class="number-right"
                    parentControlName="splits"
                    [index]="i"
                    formControlName="percentage"
                    [readonly]="isLastSplit(i)"
                    (blur)="allocateByPercentage()"
                  />
                  <span matTextSuffix>%</span>
                </mat-form-field>
              } @else {
                <mat-form-field
                  appearance="fill"
                  class="number-field no-subscript"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Member Amount</mat-label>
                  <input
                    matInput
                    #inputElement
                    #memberAmount
                    class="number-right"
                    parentControlName="splits"
                    [index]="i"
                    formControlName="assignedAmount"
                    appFormatCurrencyInput
                    (blur)="allocateSharedAmounts()"
                    inputmode="decimal"
                  />
                  @if (localeService.currency().symbolPosition === 'prefix') {
                    <span matTextPrefix>{{
                      localeService.currency().symbol
                    }}</span>
                  }
                  @if (localeService.currency().symbolPosition === 'suffix') {
                    <span matTextSuffix
                      >&nbsp;{{ localeService.currency().symbol }}</span
                    >
                  }
                  <button
                    matIconSuffix
                    mat-icon-button
                    (click)="
                      openCalculator($event, 'assignedAmount', i);
                      $event.preventDefault();
                      $event.stopPropagation()
                    "
                    aria-label="Open calculator"
                    type="button"
                  >
                    <mat-icon>calculate</mat-icon>
                  </button>
                </mat-form-field>
              }
              <div class="mock-input">
                <span class="mock-label">Allocated Amount</span>
                <span class="mock-value-right">
                  {{ splitForm.get('allocatedAmount').value | currency }}
                </span>
              </div>
            </div>
          </div>
          @if (i < splitsFormArray.length - 1) {
            <hr />
          }
        }
      </div>
    </form>
    <div class="flex-wrap fw-start row-gap mt-3">
      <button
        mat-raised-button
        class="btn-secondary"
        type="submit"
        defaultButton
        [disabled]="
          !addExpenseForm.valid ||
          addExpenseForm.disabled ||
          !expenseFullyAllocated()
        "
        (click)="onSubmit(false)"
        data-test-id="save-button"
        aria-label="Save expense"
      >
        Save
      </button>
      @if (!memorizedExpense()) {
        <button
          mat-raised-button
          class="btn-secondary"
          type="submit"
          [disabled]="
            !addExpenseForm.valid ||
            addExpenseForm.disabled ||
            !expenseFullyAllocated()
          "
          (click)="onSubmit(true)"
          data-test-id="save-and-add-another-button"
          aria-label="Save expense and add another"
        >
          Save & Add Another
        </button>
      }
      <button
        mat-stroked-button
        type="button"
        [disabled]="addExpenseForm.disabled"
        (click)="onCancel()"
        data-test-id="cancel-button"
        aria-label="Cancel adding expense"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
