@if (!memorizedStore.loaded()) {
  <div class="container pt-3" data-testid="memorized-loading-container">
    <h3 data-testid="loading-memorized-message">
      Loading memorized expenses...
    </h3>
  </div>
} @else {
  <div class="container with-table pt-3" data-testid="memorized-main-container">
    <div class="page-header" data-testid="memorized-page-header">
      <div></div>
      <h3 data-testid="memorized-page-title">Memorized Expenses</h3>
      <div class="help-icon" data-testid="memorized-help-icon-container">
        @if (demoService.isInDemoMode()) {
          <mat-icon
            data-testid="memorized-tour-button"
            matTooltip="Show Tour"
            (click)="startTour()"
            aria-label="Start memorized expenses tour"
            class="mr-2"
            >tour</mat-icon
          >
        }
        <mat-icon
          matTooltip="Help"
          (click)="showHelp()"
          data-testid="memorized-help-button"
          aria-label="Show help for memorized expenses"
          >help</mat-icon
        >
      </div>
    </div>
    <h4 data-testid="current-group-name">{{ currentGroup()?.name }}</h4>
    <div class="filters" data-testid="memorized-filters">
      <mat-form-field
        id="search-field"
        subscriptSizing="dynamic"
        data-testid="memorized-search-field"
        data-tour="memorized-search"
      >
        <mat-label>{{
          searchFocused()
            ? 'Search by payer, description, or category'
            : 'Search'
        }}</mat-label>
        <input
          matInput
          [(ngModel)]="searchText"
          (focus)="onSearchFocus()"
          (blur)="onSearchBlur()"
          data-testid="memorized-search-input"
          aria-label="Search memorized expenses by payer, description, or category"
        />
        @if (searchText() !== '') {
          <button
            matSuffix
            matIconButton
            tabindex="-1"
            aria-label="Clear"
            (click)="searchText.set('')"
            [matTooltip]="'Clear'"
            data-testid="clear-memorized-search-button"
          >
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
      <button
        mat-raised-button
        class="btn-primary"
        routerLink="/memorized/add"
        data-testid="memorize-new-expense-button"
        data-tour="memorize-button"
        aria-label="Memorize new expense"
      >
        Memorize New Expense
      </button>
    </div>
    @if (filteredMemorizeds()?.length > 0) {
      <div class="table-container mat-elevation-z8">
        <div class="scrollable-table">
          <table
            mat-table
            [dataSource]="filteredMemorizeds()"
            multiTemplateDataRows
            class="expandable-table"
            data-tour="memorized-table"
          >
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>Id</th>
              <td mat-cell *matCellDef="let expense">{{ expense.id }}</td>
            </ng-container>
            <ng-container matColumnDef="paidBy">
              <th mat-header-cell *matHeaderCellDef>Payer</th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.paidByMember.displayName }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description-category">
              <th mat-header-cell *matHeaderCellDef>
                Description<br />Category
              </th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.description }}
                <br />
                {{ expense.category.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.description }}
              </td>
            </ng-container>
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Category</th>
              <td mat-cell *matCellDef="let expense">
                {{ expense.category.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef class="cell-right">
                Amount
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-right">
                {{ expense.totalAmount | currency }}
              </td>
            </ng-container>
            <ng-container matColumnDef="create">
              <th mat-header-cell *matHeaderCellDef class="cell-center">
                Create<br />Expense
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                <button
                  mat-icon-button
                  (click)="addExpense(expense); $event.stopPropagation()"
                >
                  <mat-icon>add</mat-icon>
                </button>
              </td>
            </ng-container>
            <ng-container matColumnDef="expand">
              <th mat-header-cell *matHeaderCellDef aria-label="row actions">
                Splits
              </th>
              <td mat-cell *matCellDef="let expense" class="cell-center">
                <button
                  mat-icon-button
                  aria-label="expand row"
                  (click)="onExpandClick(expense); $event.stopPropagation()"
                >
                  @if (expandedExpense() === expense) {
                    <mat-icon>keyboard_arrow_up</mat-icon>
                  } @else {
                    <mat-icon>keyboard_arrow_down</mat-icon>
                  }
                </button>
              </td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let expense"
                [colSpan]="columnsToDisplay().length"
              >
                @if (expense == expandedExpense()) {
                  <div
                    class="detail-table-container"
                    animate.enter="detail-expand"
                    animate.leave="detail-collapse"
                  >
                    <table
                      mat-table
                      [dataSource]="expense.splits"
                      class="static-table info-detail-table"
                    >
                      @let splitColumnsToDisplay = ['owedBy', 'amount'];
                      <ng-container matColumnDef="id">
                        <th mat-header-cell *matHeaderCellDef>Id</th>
                        <td mat-cell *matCellDef="let split">{{ split.id }}</td>
                      </ng-container>
                      <ng-container matColumnDef="owedBy">
                        <th mat-header-cell *matHeaderCellDef>Owed By</th>
                        <td mat-cell *matCellDef="let split">
                          {{ split.owedByMember.displayName }}
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="amount">
                        <th
                          mat-header-cell
                          *matHeaderCellDef
                          class="cell-right"
                        >
                          Amount
                        </th>
                        <td mat-cell *matCellDef="let split" class="cell-right">
                          {{ split.allocatedAmount | currency }}
                        </td>
                      </ng-container>
                      <tr
                        mat-header-row
                        *matHeaderRowDef="splitColumnsToDisplay"
                      ></tr>
                      <tr
                        mat-row
                        *matRowDef="let split; columns: splitColumnsToDisplay"
                      ></tr>
                    </table>
                  </div>
                }
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="columnsToDisplay(); sticky: true"
            ></tr>
            <tr
              mat-row
              *matRowDef="let expense; columns: columnsToDisplay()"
              class="summary-row clickable-row expandable-row"
              [class.expanded-row]="expandedExpense === expense"
              (click)="onRowClick(expense)"
            ></tr>
            <tr
              mat-row
              *matRowDef="let split; columns: ['expandedDetail']"
              class="detail-row"
            ></tr>
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [colSpan]="columnsToDisplay().length">
                No expenses found for search criteria.
              </td>
            </tr>
          </table>
        </div>
      </div>
    } @else {
      <div class="container pt-3">
        <h5>No memorized expenses found</h5>
      </div>
    }
  </div>
}
