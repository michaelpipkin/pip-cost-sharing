<mat-toolbar class="nav" data-testid="main-toolbar">
  <mat-toolbar-row data-testid="toolbar-row">
    @if (isSmallScreen()) {
      @if (isLoggedIn() || isInDemoMode()) {
        <button
          mat-icon-button
          [matMenuTriggerFor]="menu"
          data-testid="mobile-menu-toggle"
          data-tour="mobile-navigation"
          aria-label="Open navigation menu"
        >
          <mat-icon fontSet="material-symbols-outlined">menu</mat-icon>
        </button>
      }
      <a [routerLink]="routes.HOME">
        <span id="title" data-testid="app-title-mobile">PipSplit</span>
      </a>
      <a
        matButton
        [routerLink]="isInDemoMode() ? demoRoutes.DEMO_SPLIT : routes.SPLIT"
        aria-label="split expense"
        title="Split Expense"
        data-testid="nav-split"
      >
        <mat-icon fontSet="material-symbols-outlined">arrow_split</mat-icon
        >&nbsp;Split
      </a>
      <div class="account links" data-testid="mobile-account-actions">
        <button
          matIconButton
          (click)="toggleTheme()"
          data-testid="theme-toggle-mobile"
          [aria-label]="
            themeService.currentTheme() === 'light'
              ? 'Switch to dark mode'
              : 'Switch to light mode'
          "
          [matTooltip]="
            themeService.currentTheme() === 'light'
              ? 'Switch to dark mode'
              : 'Switch to light mode'
          "
        >
          <mat-icon>
            {{
              themeService.currentTheme() === 'light'
                ? 'dark_mode'
                : 'light_mode'
            }}
          </mat-icon>
        </button>
        <a
          matIconButton
          [routerLink]="isInDemoMode() ? demoRoutes.DEMO_HELP : routes.HELP"
          matTooltip="Help"
          aria-label="help"
          data-testid="nav-help-desktop"
        >
          <mat-icon>help</mat-icon>
        </a>
        @if (!isInDemoMode() && isLoggedIn()) {
          <a
            matIconButton
            [routerLink]="['auth', 'account']"
            matTooltip="Account"
            aria-label="account"
            data-testid="nav-account-desktop"
          >
            <mat-icon>manage_accounts</mat-icon>
          </a>
          <button
            matIconButton
            (click)="logout()"
            aria-label="log out"
            matTooltip="Log out"
            data-testid="logout-button-desktop"
          >
            <mat-icon>logout</mat-icon>
          </button>
        } @else {
          <a
            matButton
            [routerLink]="['auth', 'login']"
            aria-label="login"
            matTooltip="Login"
            data-testid="nav-login-desktop"
          >
            <mat-icon>login</mat-icon>
            &nbsp;<span>Log in</span>
          </a>
        }
      </div>
    }
    @if (!isSmallScreen()) {
      <a [routerLink]="routes.HOME">
        <span id="title" data-testid="app-title-desktop">PipSplit</span>
      </a>
      <div
        class="links"
        data-testid="desktop-navigation"
        data-tour="desktop-navigation"
      >
        @if (isInDemoMode()) {
          <!-- Demo mode navigation -->
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_GROUPS"
            aria-label="demo groups"
            title="Demo Groups"
            data-testid="nav-demo-groups"
          >
            <mat-icon fontSet="material-symbols-outlined">groups</mat-icon
            >&nbsp;Groups
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_MEMBERS"
            aria-label="demo members"
            title="Demo Members"
            data-testid="nav-demo-members"
          >
            <mat-icon fontSet="material-symbols-outlined">face</mat-icon
            >&nbsp;Members
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_CATEGORIES"
            aria-label="demo categories"
            title="Demo Categories"
            data-testid="nav-demo-categories"
          >
            <mat-icon fontSet="material-symbols-outlined">category</mat-icon
            >&nbsp;Categories
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_EXPENSES"
            aria-label="demo expenses"
            title="Demo Expenses"
            data-testid="nav-demo-expenses"
          >
            <mat-icon fontSet="material-symbols-outlined">attach_money</mat-icon
            >Expenses
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_MEMORIZED"
            aria-label="demo memorized"
            title="Demo Memorized"
            data-testid="nav-demo-memorized"
          >
            <mat-icon fontSet="material-symbols-outlined"
              >currency_exchange</mat-icon
            >&nbsp;Memorized
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_SUMMARY"
            aria-label="demo summary"
            title="Demo Summary"
            data-testid="nav-demo-summary"
          >
            <mat-icon fontSet="material-symbols-outlined"
              >compare_arrows</mat-icon
            >&nbsp;Summary
          </a>
          <a
            matButton
            [routerLink]="demoRoutes.DEMO_HISTORY"
            aria-label="demo history"
            title="Demo History"
            data-testid="nav-demo-history"
          >
            <mat-icon fontSet="material-symbols-outlined">receipt</mat-icon
            >&nbsp;History
          </a>
        } @else if (isLoggedIn() && isValidUser()) {
          <!-- Regular authenticated navigation -->
          <a
            matButton
            [routerLink]="routes.ADMIN_GROUPS"
            aria-label="groups"
            title="Groups"
            data-testid="nav-groups"
          >
            <mat-icon fontSet="material-symbols-outlined">groups</mat-icon
            >&nbsp;Groups
          </a>
          @if (currentGroup() != null) {
            <a
              matButton
              [routerLink]="routes.ADMIN_MEMBERS"
              aria-label="members"
              title="Members"
              data-testid="nav-members"
            >
              <mat-icon fontSet="material-symbols-outlined">face</mat-icon
              >&nbsp;Members
            </a>
            <a
              matButton
              [routerLink]="routes.ADMIN_CATEGORIES"
              aria-label="categories"
              title="Categories"
              data-testid="nav-categories"
            >
              <mat-icon fontSet="material-symbols-outlined">category</mat-icon
              >&nbsp;Categories
            </a>
            <a
              matButton
              [routerLink]="routes.EXPENSES_ROOT"
              aria-label="expenses"
              title="Expenses"
              data-testid="nav-expenses"
            >
              <mat-icon fontSet="material-symbols-outlined"
                >attach_money</mat-icon
              >Expenses
            </a>
            <a
              matButton
              [routerLink]="routes.MEMORIZED_ROOT"
              aria-label="memorized"
              title="Memorized"
              data-testid="nav-memorized"
            >
              <mat-icon fontSet="material-symbols-outlined"
                >currency_exchange</mat-icon
              >&nbsp;Memorized
            </a>
            <a
              matButton
              [routerLink]="routes.ANALYSIS_SUMMARY"
              aria-label="summary"
              title="Summary"
              data-testid="nav-summary"
            >
              <mat-icon fontSet="material-symbols-outlined"
                >compare_arrows</mat-icon
              >&nbsp;Summary
            </a>
            <a
              matButton
              [routerLink]="routes.ANALYSIS_HISTORY"
              aria-label="history"
              title="History"
              data-testid="nav-history"
            >
              <mat-icon fontSet="material-symbols-outlined">receipt</mat-icon
              >&nbsp;History
            </a>
          }
        }
        <a
          matButton
          [routerLink]="isInDemoMode() ? demoRoutes.DEMO_SPLIT : routes.SPLIT"
          aria-label="split expense"
          title="Split Expense"
          data-testid="nav-split"
        >
          <mat-icon fontSet="material-symbols-outlined">arrow_split</mat-icon
          >&nbsp;Split
        </a>
      </div>
      <div class="account links" data-testid="desktop-account-actions">
        <button
          matIconButton
          (click)="toggleTheme()"
          data-testid="theme-toggle-desktop"
          [aria-label]="
            themeService.currentTheme() === 'light'
              ? 'Switch to dark mode'
              : 'Switch to light mode'
          "
          [matTooltip]="
            themeService.currentTheme() === 'light'
              ? 'Switch to dark mode'
              : 'Switch to light mode'
          "
        >
          <mat-icon>
            {{
              themeService.currentTheme() === 'light'
                ? 'dark_mode'
                : 'light_mode'
            }}
          </mat-icon>
        </button>
        <a
          matIconButton
          [routerLink]="isInDemoMode() ? demoRoutes.DEMO_HELP : routes.HELP"
          matTooltip="Help"
          aria-label="help"
          data-testid="nav-help-desktop"
        >
          <mat-icon>help</mat-icon>
        </a>
        @if (!isInDemoMode() && isLoggedIn()) {
          <a
            matIconButton
            [routerLink]="['auth', 'account']"
            matTooltip="Account"
            aria-label="account"
            data-testid="nav-account-desktop"
          >
            <mat-icon>manage_accounts</mat-icon>
          </a>
          <button
            matIconButton
            (click)="logout()"
            aria-label="log out"
            matTooltip="Log out"
            data-testid="logout-button-desktop"
          >
            <mat-icon>logout</mat-icon>
          </button>
        } @else {
          <a
            matButton
            [routerLink]="['auth', 'login']"
            aria-label="login"
            matTooltip="Login"
            data-testid="nav-login-desktop"
          >
            <mat-icon>login</mat-icon>
            &nbsp;<span>Log in</span>
          </a>
        }
      </div>
    }
  </mat-toolbar-row>
</mat-toolbar>

<mat-menu #menu="matMenu" data-testid="mobile-menu">
  <div class="menu" data-testid="mobile-menu-content">
    @if (isInDemoMode()) {
      <!-- Demo mode navigation -->
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_GROUPS"
        aria-label="demo groups"
        title="Demo Groups"
        data-testid="mobile-nav-demo-groups"
      >
        <mat-icon fontSet="material-symbols-outlined">groups</mat-icon
        >&nbsp;Groups
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_MEMBERS"
        aria-label="demo members"
        title="Demo Members"
        data-testid="mobile-nav-demo-members"
      >
        <mat-icon fontSet="material-symbols-outlined">face</mat-icon
        >&nbsp;Members
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_CATEGORIES"
        aria-label="demo categories"
        title="Demo Categories"
        data-testid="mobile-nav-demo-categories"
      >
        <mat-icon fontSet="material-symbols-outlined">category</mat-icon
        >&nbsp;Categories
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_EXPENSES"
        aria-label="demo expenses"
        title="Demo Expenses"
        data-testid="mobile-nav-demo-expenses"
      >
        <mat-icon fontSet="material-symbols-outlined">attach_money</mat-icon
        >Expenses
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_MEMORIZED"
        aria-label="demo memorized"
        title="Demo Memorized"
        data-testid="mobile-nav-demo-memorized"
      >
        <mat-icon fontSet="material-symbols-outlined"
          >currency_exchange</mat-icon
        >&nbsp;Memorized
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_SUMMARY"
        aria-label="demo summary"
        title="Demo Summary"
        data-testid="mobile-nav-demo-summary"
      >
        <mat-icon fontSet="material-symbols-outlined">compare_arrows</mat-icon
        >&nbsp;Summary
      </a>
      <a
        mat-menu-item
        [routerLink]="demoRoutes.DEMO_HISTORY"
        aria-label="demo history"
        title="Demo History"
        data-testid="mobile-nav-demo-history"
      >
        <mat-icon fontSet="material-symbols-outlined">receipt</mat-icon
        >&nbsp;History
      </a>
    } @else if (isLoggedIn() && isValidUser()) {
      <!-- Regular authenticated navigation -->
      <a
        mat-menu-item
        [routerLink]="routes.ADMIN_GROUPS"
        aria-label="groups"
        title="Groups"
        data-testid="mobile-nav-groups"
      >
        <mat-icon fontSet="material-symbols-outlined">groups</mat-icon
        >&nbsp;Groups
      </a>
      @if (currentGroup() != null) {
        <a
          mat-menu-item
          [routerLink]="routes.ADMIN_MEMBERS"
          aria-label="members"
          title="Members"
          data-testid="mobile-nav-members"
        >
          <mat-icon fontSet="material-symbols-outlined">face</mat-icon
          >&nbsp;Members
        </a>
        <a
          mat-menu-item
          [routerLink]="routes.ADMIN_CATEGORIES"
          aria-label="categories"
          title="Categories"
          data-testid="mobile-nav-categories"
        >
          <mat-icon fontSet="material-symbols-outlined">category</mat-icon
          >&nbsp;Categories
        </a>
        <a
          mat-menu-item
          [routerLink]="routes.EXPENSES_ROOT"
          aria-label="expenses"
          title="Expenses"
          data-testid="mobile-nav-expenses"
        >
          <mat-icon fontSet="material-symbols-outlined">attach_money</mat-icon
          >Expenses
        </a>
        <a
          mat-menu-item
          [routerLink]="routes.MEMORIZED_ROOT"
          aria-label="memorized"
          title="Memorized"
          data-testid="mobile-nav-memorized"
        >
          <mat-icon fontSet="material-symbols-outlined"
            >currency_exchange</mat-icon
          >&nbsp;Memorized
        </a>
        <a
          mat-menu-item
          [routerLink]="routes.ANALYSIS_SUMMARY"
          aria-label="summary"
          title="Summary"
          data-testid="mobile-nav-summary"
        >
          <mat-icon fontSet="material-symbols-outlined">compare_arrows</mat-icon
          >&nbsp;Summary
        </a>
        <a
          mat-menu-item
          [routerLink]="routes.ANALYSIS_HISTORY"
          aria-label="history"
          title="History"
          data-testid="mobile-nav-history"
        >
          <mat-icon fontSet="material-symbols-outlined">receipt</mat-icon
          >&nbsp;History
        </a>
      }
    }
  </div>
</mat-menu>
<loading data-testid="loading-component" />
<div id="outlet" data-testid="main-content">
  <router-outlet />
</div>
<!-- TEMPORARY DEBUG - REMOVE AFTER TESTING -->
<div
  style="
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    background: #ff0;
    color: #000;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    z-index: 9999;
  "
>
  <div>isNative={{ debugIsNative }}</div>
  <div>platform={{ debugPlatform }}</div>
  <div>displayMode={{ debugDisplayMode() }}</div>
</div>
<!-- END TEMPORARY DEBUG -->
<footer data-testid="main-footer"></footer>
